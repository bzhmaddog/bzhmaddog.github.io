<!DOCTYPE html>
<html>
    <head>
        <meta httpEquiv="origin-trial" content="AkfwxtdOv8lmILy1N481kK//CxRGUt8ZVnkI1Ef594MR9ZuWXiEG+nMchAsePoS/4CcSpqYhu+kQFyYXku4ZpAEAAABTeyJvcmlnaW4iOiJodHRwczovL2J6aG1hZGRvZy5naXRodWIuaW86NDQzIiwiZmVhdHVyZSI6IldlYkdQVSIsImV4cGlyeSI6MTY5MTcxMTk5OX0=" />

        <style>
            * {
	            box-sizing: border-box;
            }
            body {
                background:  black;
                padding: 0;
                margin: 0;
                overflow: hidden;
            }

            span, li, label {
                color: white;
            }

            /*#output {
                border: 1px solid red;
            }*/
        </style>
    </head>
    <body>
        <canvas id="output" width="1280" height="390"></canvas>
        <br />
        <div id="checkboxes">
            <div>
                <input id="background_checkbox" type="checkbox" data-layer="bg" checked />
                <label for="background_checkbox">Background</label>
            </div>
            <div>
                <input id="sprite_checkbox" type="checkbox" data-layer="sprite" checked />
                <label for="sprite_checkbox">Sprite</label>
            </div>
            <div>
                <input id="animation_checkbox" type="checkbox" data-layer="animation" checked />
                <label for="animation_checkbox">background animation</label>
            </div>
            <div>
                <input id="vstext_checkbox" type="checkbox" data-layer="text2" checked />
                <label for="vstext_checkbox">VS text inner</label>
            </div>
            <div>
                <input id="vstext_checkbox2" type="checkbox" data-layer="text3" checked />
                <label for="vstext_checkbox2">VS text outer</label>
            </div>
            <div>
                <input id="scotttext_checkbox" type="checkbox" data-layer="text1" checked/>
                <label for="scotttext_checkbox">Scott pilgrim text</label>
            </div>
            <div>
                <input id="matthewtext_checkbox" type="checkbox" data-layer="text4" checked />
                <label for="matthewtext_checkbox">Matthew Patel text</label>
            </div>
            <div>
                <input id="matthewimg_checkbox" type="checkbox" data-layer="canvas" checked />
                <label for="matthewimg_checkbox">Matthew Patel Image</label>
            </div>
        </div>

        <div style="margin-top:20px">
            <span>Note (2023/02/18) : This demo have been tested  working on the following browsers :</span>
            <ul>
                <li>Windows: Chromium 105, 107, 110</li>
                <li>ArchLinux: Chromium 109 (google-chrome-dev 109.0.5414.10-1)</li>
                <li>MacOs: Chrome Canary (TBD)</li>
            </ul>
        </div>

        <script type="module">
            import { DMD } from './js/DMD.mjs';
            import { Utils } from './js/Utils.mjs';
            import { Colors } from './js/Colors.mjs';
            import { CanvasLayer } from './js/CanvasLayer.mjs';

            (function () {
                'use strict';

                // When dom is loaded create the objects and bind the events
                document.addEventListener('DOMContentLoaded', function () {

                    // Check if webgpu is supported
                    if ("gpu" in navigator) {
                        var output = document.getElementById('output');

                    // 256x78
                    //var dmd = new DMD(output, 4, 1, 1, 1, DMD.DotShape.Square, 14, 1, true);

                    // 426x130
                    var dmd = new DMD(output, 2, 1, 1, 1, DMD.DotShape.Square, 14, 1, true);

                    // 320x97
                    //var dmd = new DMD(output, 2, 2, 1, 1, DMD.DotShape.Square, 14, 1, true);

                    // 128x39
                    //var dmd = new DMD(output, 7, 3, 1, 1, DMD.DotShape.Square, 14, 1, true);

                    window.dmd = dmd;

                    // Init DMD then
        			dmd.init().then( () => {

                        // Start rendering dmd
                        dmd.run();

                        // Create background layer
                        dmd.createLayer(DMD.LayerType.Image, 'bg', {
                            src : 'images/boss-mode-bg.png',
                            //opacity : 0.1
                        });

                        // Create background animation layer
                        dmd.createLayer(DMD.LayerType.Animation, 'animation', {
                            images : [
                                'images/animation/0.webp',
                                'images/animation/1.webp',
                                'images/animation/2.webp',
                                'images/animation/3.webp',
                                'images/animation/4.webp',
                                'images/animation/5.webp',
                                'images/animation/6.webp',
                                'images/animation/7.webp',
                                'images/animation/8.webp',
                                'images/animation/9.webp',
                                'images/animation/10.webp',
                                'images/animation/11.webp',
                                'images/animation/12.webp',
                                'images/animation/13.webp',
                                'images/animation/14.webp'
                            ],
                            duration : 800,
                            autoplay : true,
                            loop : true
                        });

                        // Create a canvas layer to display Matthew image
                        var canvasLayer = dmd.createLayer(DMD.LayerType.Canvas, 'canvas', {}, function() {
                            var img = new Image();

		                    img.onload = function() {
                                // x,y coordinate are related to the screen width/height (not dmd width/height) to be consistant depending on the settings used
			                    canvasLayer.drawImage(
                                    img,
                                    {
                                        align: 'right',
                                        vAlign : 'middle',
                                        height : '70%'
                                    }
                                );
		                    }

                            img.src = 'images/boss-matthew-big.png';
                        });

                        // Create a text
                        var textLayer1 = dmd.createLayer(DMD.LayerType.Text, 'text1', {
                            'text' : "Scott Pilgrim",
                            left : '0',
                            top : 0,
                            fontSize : 10
                        });

                        // Create another text
                        var textLayer2 = dmd.createLayer(DMD.LayerType.Text, 'text2', {
                            'text' : "VS",
                            align : 'center',
                            vAlign : 'middle',
                            fontFamily : 'Arial',
                            fontSize : 40,
                            fontStyle : 'italic bold',
                            color : '#FFFFFF80', // RGBA
                            hOffset : '-15%'
                        });

                        // Create another text
                        var textLayer3 = dmd.createLayer(DMD.LayerType.Text, 'text3', {
                            'text' : "VS",
                            align : 'center',
                            vAlign : 'middle',
                            fontFamily : 'Arial',
                            fontSize : 40,
                            fontStyle : 'italic bold',
                            color : '#00000000', // totally transparent
                            strokeWidth : 2,
                            strokeColor : Colors.red,
                            hOffset : '-15%'
                        });

                        // Another text
                        var textLayer4 = dmd.createLayer(DMD.LayerType.Text, 'text4', {
                            'text' : "Matthew Patel",
                            align : 'right',
                            vAlign : 'bottom',
                            fontSize : 10,
                            hOffset : -1
                        });

                        // Create a sprite layer and run sprite animation sequence forever
                        var spriteLayer = dmd.createLayer(DMD.LayerType.Sprites, 'sprite', {}, function() {
                            spriteLayer.createSprite(
                                'scott',
                                'images/scott2x.png',
                                6,
                                0,
                                [
                                    ['idle', 8, 72, 118, 0, 0, 900], //800
                                    ['walk', 6, 72, 126, 0, 118, 1100],
                                    ['run', 8, 106, 120, 0, 244, 650],
                                    ['idle2', 4, 92, 124, 0, 364, 900],
                                    ['taunt', 9, 92, 124, 0, 488, 450]
                                ],
                                '2%',
                                '2%'
                            ).then(() => {
                                let seq = [
                                            ['idle' , 3],
                                            ['walk' , 5],
                                            ['run', 4],
                                            ['taunt', 1]
                                            //['idle2', 1]
                                        ];

                                spriteLayer.enqueueSequence('scott', seq, true);
                                spriteLayer.run('scott');
                            });
                        });                      
                        
                        var checkboxElems = document.querySelectorAll("input[type='checkbox']");

                        // Add click event listener on checkboxes to enable/disable each layer
                        for (var i = 0; i < checkboxElems.length; i++) {
                            checkboxElems[i].addEventListener("click", function(element) {
                                var layerName = element.target.dataset.layer;
                                var visible = element.target.checked
                                var layer = dmd.getLayer(layerName);

                                if (layer != null) {
                                    layer.setVisibility(visible);

                                    if (visible) {
                                        if (layerName === "sprite") {
                                            layer.run('scott');
                                        }
                                    }
                                
                                } else {
                                    console.log(`Layer not found : ${layerName}`);
                                }

                            });
                        }

                    });

                } else {
                    alert('Sorry your browser does not support WEBGPU (or the feature is not enabled)');
                }


                },false);
            })();
        </script>
    </body>
</html>
